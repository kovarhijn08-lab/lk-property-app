# Журнал проверок (Verification Log)

Этот файл содержит список действий для ручной проверки текущего состояния систем Skynet и устойчивости приложения.

## 1. Проверка Всевидящего ока (Global Logs)
- [ ] **Действие**: Выйдите из аккаунта и создайте нового тестового пользователя.
- [ ] **Ожидаемый результат**: В админ-панели (под админом) во вкладке **Global Logs** должна появиться запись `New user registered: [email]`.
- [ ] **Действие**: Под новым пользователем создайте проект (Property).
- [ ] **Ожидаемый результат**: В логах должна появиться запись `New property created: "[Name]"`.

## 2. Проверка системы восстановления (Undo/Restore)
- [ ] **Действие**: Удалите любой проект (Property).
- [ ] **Ожидаемый результат**: В логах (Global Logs) должна появиться запись `Delete snapshot for "[ID]"`.
- [ ] **Действие**: Нажмите на синюю кнопку **↺ RESTORE DATA** рядом с этой записью.
- [ ] **Ожидаемый результат**: Проект должен снова появиться в списке объектов (проверьте на главной странице или в списке объектов).

## 3. Проверка живого списка пользователей
- [ ] **Действие**: Откройте админку на вкладке **Users**. В другом окне или в режиме инкогнито зарегистрируйте нового пользователя.
- [ ] **Ожидаемый результат**: Новый пользователь должен появиться в списке в админке мгновенно, без перезагрузки страницы.

## 4. Проверка монитора задержек (Latency)
- [ ] **Действие**: Зайдите в админку на вкладку **Overview**.
- [ ] **Ожидаемый результат**: Вы должны видеть число задержки (например, `45ms`) и мини-график из 10 последних замеров.

## 5. Минимальные E2E Сценарии (P1.5)
- [x] **E2E 1: Полный цикл входа** (PASS — 2026-01-29, localhost)
  - **Действие**: Выход -> Вход под админом.
  - **Ожидаемый результат**: Редирект на Dashboard, отсутствие ошибок в консоли.
- [ ] **E2E 2: Создание и видимость** (FAIL — 2026-01-29, localhost)
  - **Действие**: Создать Property "P1.5 Test".
  - **Ожидаемый результат**: Объект появляется в списке мгновенно.
  - **Факт**: объект появляется в UI, но после reload `properties` = 0 (не сохраняется/не читается из Firestore).
  - **Обновление (2026-01-30)**: добавлен fallback‑запрос по `userId` при ошибках индекса/permission (commit `92e5762`). Требуется повторная проверка.
- [ ] **E2E 3: Финансы и Метрики** (FAIL — 2026-01-29, localhost)
  - **Действие**: Добавить транзакцию $1000 (Rent) в новый объект.
  - **Ожидаемый результат**: Cash Flow и Gross Revenue на Dashboard обновляются.
  - **Факт**: форма открывается, но данные не сохраняются (после reload транзакций нет).
  - **Обновление (2026-01-30)**: после стабилизации чтения properties повторить проверку (commit `92e5762`).
- [ ] **E2E 4: Безопасность Impersonation**
  - **Действие**: Ghost Mode -> Выбрать Tenant.
  - **Ожидаемый результат**: Видны только объекты этого Tenant. Доступ к Admin-панели заблокирован (скрыт).
- [ ] **E2E 5: Устойчивость сессии**
  - **Действие**: Обновить страницу (F5) во время Ghost Mode.
  - **Ожидаемый результат**: Ghost Mode сохраняется, данные не пропадают.

## 6. Проверка усиленной безопасности (Security Hardening)
- [ ] **E2E 6: Регистрация жильца без инвайта**
  - **Действие**: Перейти на `/signup`, выбрать роль Жилец (если доступно) или попытаться отправить форму регистрации жильца без токена инвайта (имитируя вызов API).
  - **Ожидаемый результат**: `AuthContext` должен выдать ошибку, пользователь не должен быть создан в Firestore.
- [ ] **E2E 7: Использование чужого инвайта**
  - **Действие**: Попытаться зарегистрироваться по инвайту, который уже был использован другим UID.
  - **Ожидаемый результат**: Firestore rules должны заблокировать создание документа пользователя, так как `usedBy` в инвайте не совпадает.
- [ ] **E2E 8: Доступ к объектам по UID (UID isolation)**
  - **Действие**: Под жильцом попытаться прочитать объект, где его UID нет в `tenantIds`, но Email совпадает с `tenantEmails`.
  - **Ожидаемый результат**: Отказ в доступе (Permission Denied), так как правила теперь требуют наличия UID в `tenantIds`.
- [ ] **E2E 9: Скрытые инвайты**
  - **Действие**: Попытаться прочитать коллекцию `invitations` полностью под обычным жильцом.
  - **Ожидаемый результат**: Ошибка доступа. Разрешено только PMC и Owner.

## 7. Tenant Portal (Unified)
- [ ] **TP 1: Единый портал**
  - **Действие**: Войти как Tenant и открыть портал.
  - **Ожидаемый результат**: Видны вкладки Dashboard / Fix / Chat / Docs, нет панелей Admin/Owner.
- [ ] **TP 2: Messaging**
  - **Действие**: Отправить сообщение и файл (изображение или PDF).
  - **Ожидаемый результат**: Отображаются вложения, есть индикатор read/typing.
- [ ] **TP 3: Maintenance**
  - **Действие**: Создать заявку на ремонт и проверить timeline статусов.
  - **Ожидаемый результат**: Заявка создается и отображается в списке с timeline.
- [ ] **TP 4: Documents**
  - **Действие**: Открыть Documents.
  - **Ожидаемый результат**: Доступны только документы жильца, видна кнопка View/Download.
- [ ] **TP 5: Profile & Notifications**
  - **Действие**: Открыть Profile, изменить телефон и переключить уведомления.
  - **Ожидаемый результат**: Настройки сохраняются (после перезагрузки остаются).

## 8. Global Error Logging (Skynet)
- [ ] **GE 1: window.onerror**
  - **Действие**: В консоли выполнить `setTimeout(() => { throw new Error('Skynet global error test') }, 0)`.
  - **Ожидаемый результат**: В `system_logs` появляется запись с action `global.error`.
- [ ] **GE 2: unhandledrejection**
  - **Действие**: В консоли выполнить `Promise.reject(new Error('Skynet rejection test'))`.
  - **Ожидаемый результат**: В `system_logs` появляется запись с action `global.unhandledrejection`.

## 9. Skynet Dedupe & Version
- [ ] **DV 1: App Version**
  - **Действие**: Открыть Admin Console → Overview.
  - **Ожидаемый результат**: Отображается поле `App Version`.
- [ ] **DV 2: Suppressed Count**
  - **Действие**: В консоли несколько раз подряд вызвать одну и ту же ошибку (5+ раз).
  - **Ожидаемый результат**: В `system_logs` в `metadata.suppressedCount` увеличивается значение.

## 10. Admin & Tenant Polish
- [ ] **AP 1: Logs Export**
  - **Действие**: Admin Console → Logs → нажать `Export JSON`.
  - **Ожидаемый результат**: скачивается `logs.json`.
- [ ] **AP 2: Incidents Export**
  - **Действие**: Admin Console → Incidents → нажать `Export JSON`.
  - **Ожидаемый результат**: скачивается `incidents.json`.
- [ ] **AP 3: Mobile Overlay Clicks**
  - **Действие**: На мобильном открыть SideDrawer/модалку и проверить клики по элементам.
  - **Ожидаемый результат**: нижняя навигация не перекрывает модалки/дроверы. (Исправление z-index в commit `92e5762`)
- [ ] **TP 6: Quick Actions Navigation**
  - **Действие**: Tenant Dashboard → клик по карточкам Quick Actions.
  - **Ожидаемый результат**: переходы на Chat / Maintenance / Docs.

## 11. Admin Users UX
- [ ] **AU 1: Search & Role Filter**
  - **Действие**: Admin Console → Users → ввести search + выбрать роль.
  - **Ожидаемый результат**: список фильтруется, отображается счётчик `filtered/total`.
- [ ] **AU 2: Users Export**
  - **Действие**: Admin Console → Users → нажать `Export JSON`.
  - **Ожидаемый результат**: скачивается `users.json`.
- [ ] **AU 3: Role Edit Admin‑Only**
  - **Действие**: Войти под не‑админом и открыть Users.
  - **Ожидаемый результат**: роль отображается как текст, без возможности смены.

## 12. Invite Link Generation
- [ ] **INV 1: Generate Invite**
  - **Действие**: Owner/PMC → Property → Tenant → Invite → Generate Invite Link.
  - **Ожидаемый результат**: появляется ссылка + доступна кнопка Copy.
- [ ] **INV 2: Permission Error**
  - **Действие**: Попытаться создать инвайт под ролью без прав.
  - **Ожидаемый результат**: отображается ошибка в UI, событие фиксируется в `system_logs`.
- [ ] **INV 3: PMC Invite**
  - **Действие**: Owner/Admin → Property → Invite PMC → Generate Invite Link → открыть `/app/signup?invite=...&role=pmc`.
  - **Ожидаемый результат**: регистрация проходит, у PMC доступ к объекту через `managerIds`.

## 13. Tenant Entry Routes
- [ ] **TR 1: Tenant Login**
  - **Действие**: Открыть `/tenant`.
  - **Ожидаемый результат**: сразу показывается логин (без выбора роли).
- [ ] **TR 2: Invite Link**
  - **Действие**: Открыть `/tenant/signup?invite=...`.
  - **Ожидаемый результат**: открывается форма регистрации Tenant.
- [ ] **TR 3: Invite-Only Notice**
  - **Действие**: Открыть `/tenant` без инвайта.
  - **Ожидаемый результат**: отображается уведомление о регистрации только по приглашению.
- [ ] **TR 4: PMC Self-Signup Blocked**
  - **Действие**: Открыть `/app` → Sign Up и проверить доступные роли.
  - **Ожидаемый результат**: доступен только Owner, PMC саморегистрация недоступна.

## 14. Admin + Tenant UX (Next Action / Copy)
- [ ] **AX 1: Log Copy**
  - **Действие**: Admin Console → Logs → открыть запись → нажать `Copy JSON`.
  - **Ожидаемый результат**: JSON копируется в буфер обмена, кнопка показывает `Copied`.
- [ ] **TX 1: Next Action CTA**
  - **Действие**: В Tenant Dashboard появление unread/maintenance.
  - **Ожидаемый результат**: кнопка Next Action ведёт в Chat или Maintenance.

## 15. Access Error Logging (Skynet)
- [ ] **AE 1: Firestore Permission Denied**
  - **Действие**: Под пользователем без прав попытаться создать инвайт или прочитать `invitations` list.
  - **Ожидаемый результат**: в `system_logs` появляется запись с action `db.access.denied` и указанным `operation`.

## 16. Onboarding Role Lock
- [ ] **ONB 1: Role Locked**
  - **Действие**: Войти новым пользователем с уже заданной ролью и открыть онбординг.
  - **Ожидаемый результат**: выбор роли недоступен, отображается роль + кнопка Continue.
- [ ] **ONB 2: Currency Selection**
  - **Действие**: Onboarding → Step 2 → выбрать валюту объекта.
  - **Ожидаемый результат**: объект создаётся в выбранной валюте, она отображается в карточке объекта.

## 17. Property Currency
- [ ] **PC 1: Default Currency**
  - **Действие**: Добавить объект в форме Add Property.
  - **Ожидаемый результат**: валюта по умолчанию USD, можно выбрать THB/AED/IDR/RUB.
- [ ] **PC 2: Currency Display**
  - **Действие**: Открыть карточку объекта.
  - **Ожидаемый результат**: цены отображаются в валюте объекта.
- [ ] **PC 3: Advanced Fields**
  - **Действие**: В форме Add Property нажать Show advanced.
  - **Ожидаемый результат**: видны поля Monthly Income / Expenses и Tags.

## 18. Quick Start (Aha)
- [ ] **QS 1: Aha Panel**
  - **Действие**: Войти под Owner/PMC без документов.
  - **Ожидаемый результат**: видна панель Quick Start с задачами (создать объект, добавить 2 документа).

## 18.1 Assistant Coach
- [ ] **AS 1: Next Best Action**
  - **Действие**: Войти под Owner/PMC и открыть Global Dashboard.
  - **Ожидаемый результат**: карточка Araya Assistant показывает следующий шаг и прогресс в %.
- [ ] **AS 2: Open Assistant Chat**
  - **Действие**: Нажать кнопку “Спросить ассистента”.
  - **Ожидаемый результат**: открывается окно Araya Assistant (SupportChat).

## 18.2 Owner Portal Quick Actions
- [ ] **OP 1: Quick Actions**
  - **Действие**: Войти под Owner и открыть Owner Portal.
  - **Ожидаемый результат**: видны Quick actions (Add Property / Open first property / Legal Hub), кнопки работают.

## 18.3 Assistant Chat Guide
- [ ] **AC 1: Guide + Prompts**
  - **Действие**: Открыть чат поддержки под Owner/PMC.
  - **Ожидаемый результат**: видны подсказки‑chips и блок “Quick guide / Быстрый гид”.

## 18.4 PMC Quick Actions
- [ ] **PMC 1: Quick Actions**
  - **Действие**: Войти под PMC и открыть Global Dashboard.
  - **Ожидаемый результат**: виден блок PMC Quick Actions, кнопки открывают календарь, бронирования, документы и чаты.

## 18.5 Navigation Drawer Chats
- [ ] **NAV 1: Chats Link**
  - **Действие**: Открыть боковое меню и нажать “Чаты”.
  - **Ожидаемый результат**: открывается список чатов (GlobalChatList).

## 19. Booking UX
- [ ] **BK 1: Summary**
  - **Действие**: Создать бронирование (Guest) и выбрать даты.
  - **Ожидаемый результат**: в форме отображается Summary с валютой и количеством ночей.
- [ ] **BK 2: Required Fields**
  - **Действие**: Оставить пустым Guest Name и попытаться сохранить.
  - **Ожидаемый результат**: кнопка Save неактивна, показывается подсказка.

## 20. Documents UX (Contracts & Vault)
- [ ] **DOC 1: Non‑Lease Document**
  - **Действие**: В Legal → Add → выбрать категорию Invoice/Receipt/Act, ввести Document Title и сохранить.
  - **Ожидаемый результат**: документ отображается без поля Tenant, в карточке видны категория и название.
- [ ] **DOC 2: File Attach**
  - **Действие**: При добавлении документа выбрать файл (PDF/PNG).
  - **Ожидаемый результат**: имя файла отображается в списке документов.
- [ ] **DOC 3: Vault Filter**
  - **Действие**: Legal Hub → Vault → выбрать категорию (Invoice/Receipt/Act).
  - **Ожидаемый результат**: фильтр показывает только документы выбранной категории.

---
*Если что-то не работает, проверьте, были ли деплойнуты правила Firestore: `firebase deploy --only firestore:rules`*
